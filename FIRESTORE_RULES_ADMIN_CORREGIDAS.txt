rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Función helper para verificar si un usuario es admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // Usuarios: cada usuario solo puede leer/escribir su propio documento
    // EXCEPCIÓN: los administradores pueden crear documentos de nuevos usuarios
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && (request.auth.uid == userId || isAdmin()) && resource == null;
    }

    // NUEVA: Colección usuarios (que usa tu app)
    match /usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Permitir que administradores creen documentos de nuevos usuarios
      allow create: if request.auth != null && (request.auth.uid == userId || isAdmin()) && resource == null;
      // Permitir que administradores lean todos los usuarios para verificar permisos
      allow read: if isAdmin();
    }

    // NUEVA: Colección graficas (para estadísticas)
    match /graficas/{document} {
      allow read, write: if request.auth != null;
    }

    // Mascotas y subcolecciones
    match /pets/{petId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // Subcolección de horarios de alimentación
      match /feedingTimes/{timeId} {
        allow read, write, create: if request.auth != null &&
          get(/databases/$(database)/documents/pets/$(petId)).data.userId == request.auth.uid;
      }

      // Subcolección de porciones
      match /portions/{portionId} {
        allow read, write, create: if request.auth != null &&
          get(/databases/$(database)/documents/pets/$(petId)).data.userId == request.auth.uid;
      }

      // Subcolección de historial de alimentación
      match /feedingHistory/{historyId} {
        allow read, write, create: if request.auth != null &&
          get(/databases/$(database)/documents/pets/$(petId)).data.userId == request.auth.uid;
      }
    }

    // Registros de alimentación - REGLA SIMPLIFICADA para que funcione con tu app
    match /feedingRecords/{recordId} {
      allow read, write: if request.auth != null;
    }

    // Horarios de alimentación (colección independiente)
    match /feeding_schedules/{scheduleId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Dispensadores
    match /dispensers/{dispenserId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Estadísticas
    match /statistics/{statId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Mensajes de contacto: cualquiera puede crear, nadie puede leer/editar/borrar
    match /contactMessages/{msgId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    // Denegar acceso a cualquier otra colección no especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
